<!DOCTYPE html>
<html lang="es" class="bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f97316">

    <style>
        :root { --primary: #f97316; --primary-dark: #ea580c; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom, #0f172a, #1e293b); min-height: 100vh; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .player-shadow { box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.5); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); }
        .episode-card { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .episode-card:hover { background: linear-gradient(to right, rgba(249, 115, 22, 0.1), rgba(31, 41, 55, 0.8)); border-left: 3px solid var(--primary); }
        .progress-container { position: relative; height: 4px; background-color: #4a5568; border-radius: 2px; overflow: hidden; cursor: pointer; }
        .progress-bar { position: absolute; height: 100%; background: linear-gradient(to right, var(--primary), var(--primary-dark)); border-radius: 2px; transition: width 0.1s linear; }
        .play-btn { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3); transition: all 0.2s ease; }
        .play-btn:hover { transform: scale(1.05); box-shadow: 0 6px 15px rgba(249, 115, 22, 0.4); }
        .control-btn { transition: all 0.2s ease; }
        .control-btn:hover { color: var(--primary); transform: scale(1.1); }
    </style>
</head>
<body class="text-white">
    <header class="bg-gray-800/80 backdrop-blur-sm py-4 px-6 border-b border-gray-700 sticky top-0 z-10">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center">
                <i class="fas fa-podcast text-orange-500 mr-3"></i>
                <span>Podcast App</span>
            </h1>
            <div class="flex space-x-4">
                <button class="p-2 rounded-full hover:bg-gray-700">
                    <i class="fas fa-search"></i>
                </button>
                <button class="p-2 rounded-full hover:bg-gray-700">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </header>

    <div id="app-container" class="pb-40 px-4">

        <div id="podcasts-view" class="py-4">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-orange-500">Mis Podcasts</h1>
            </div>
            <div id="podcasts-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                </div>
        </div>

        <div id="episodes-view" class="hidden py-4 fade-in">
            <button id="back-to-podcasts" class="mb-6 text-orange-400 font-semibold flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Volver a podcasts
            </button>
            <div id="podcast-header" class="text-center mb-8"></div>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Episodios</h2>
                <div class="text-sm text-gray-400">
                    <i class="fas fa-headphones mr-1"></i>
                    <span id="episodes-count">0</span> episodios
                </div>
            </div>
            <div id="episodes-list" class="space-y-4"></div>
            <div id="episodes-loader" class="text-center py-10">
                <div class="flex justify-center mb-4">
                    <i class="fas fa-spinner fa-spin text-3xl text-orange-500"></i>
                </div>
                <p>Cargando episodios...</p>
            </div>
             <div id="episodes-error" class="hidden text-center py-10 bg-red-900/30 rounded-lg">
                <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-3"></i>
                <p>No se pudo cargar el feed RSS de este podcast.</p>
                <button class="mt-4 px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg font-medium">
                    Reintentar
                </button>
            </div>
        </div>
    </div>

    <div id="player" class="hidden fixed bottom-0 left-0 right-0 bg-gray-800/95 backdrop-blur-lg border-t border-gray-700 p-4 player-shadow fade-in z-20">
        <div class="flex items-center mb-3">
            <img id="player-artwork" src="" class="w-14 h-14 rounded-lg mr-3 shadow-md" alt="Carátula del episodio">
            <div class="flex-grow overflow-hidden">
                <p id="player-episode-title" class="font-bold text-sm truncate">Selecciona un episodio</p>
                <p id="player-podcast-title" class="text-xs text-gray-400 truncate"></p>
            </div>
            <button id="player-close" class="ml-2 text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex items-center mb-3">
            <span id="current-time" class="text-xs text-gray-400 w-10 text-center">0:00</span>
            <div class="flex-grow mx-2 relative progress-container">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
            <span id="duration" class="text-xs text-gray-400 w-10 text-center">0:00</span>
        </div>
        
        <div class="flex justify-center items-center space-x-8">
            <button id="player-rewind" class="control-btn text-xl text-gray-300">
                 <i class="fas fa-rotate-left"></i>
            </button>
            <button id="player-play-pause" class="play-btn w-12 h-12 rounded-full flex items-center justify-center text-xl">
                <i class="fas fa-play"></i>
            </button>
            <button id="player-forward" class="control-btn text-xl text-gray-300">
                <i class="fas fa-rotate-right"></i>
            </button>
        </div>
    </div>

    <audio id="audio-element"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DEL DOM ---
            const podcastsView = document.getElementById('podcasts-view');
            const episodesView = document.getElementById('episodes-view');
            const podcastsGrid = document.getElementById('podcasts-grid');
            const episodesList = document.getElementById('episodes-list');
            const podcastHeader = document.getElementById('podcast-header');
            const backToPodcastsBtn = document.getElementById('back-to-podcasts');
            const episodesLoader = document.getElementById('episodes-loader');
            const episodesErrorEl = document.getElementById('episodes-error');
            const episodesCountEl = document.getElementById('episodes-count');
            const player = document.getElementById('player');
            const playerCloseBtn = document.getElementById('player-close');
            const audioElement = document.getElementById('audio-element');
            const playerArtwork = document.getElementById('player-artwork');
            const playerEpisodeTitle = document.getElementById('player-episode-title');
            const playerPodcastTitle = document.getElementById('player-podcast-title');
            const playerPlayPauseBtn = document.getElementById('player-play-pause');
            const playerRewindBtn = document.getElementById('player-rewind');
            const playerForwardBtn = document.getElementById('player-forward');
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.querySelector('.progress-container');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');

            // --- DATOS Y ESTADO ---
            const CORS_PROXY = "/proxy?url=";
            const podcasts = [
                { name: "A dos bandas", rssUrl: "https://www.omnycontent.com/d/playlist/7e594858-42ba-4ecb-86d8-ad1a002e5281/1d39fbf3-b41a-4c54-88ec-adcd0136c774/df3205fa-ee92-4df4-9308-adcd0136c791/podcast.rss", artworkUrl: "https://www.omnycontent.com/d/playlist/7e594858-42ba-4ecb-86d8-ad1a002e5281/1d39fbf3-b41a-4c54-88ec-adcd0136c774/df3205fa-ee92-4df4-9308-adcd0136c791/image.jpg?t=1729520499&size=Large" },
                { name: "Brazalete Negro", rssUrl: "https://www.primaverasound.com/radio/shows/brazalete-negro?action=rss", artworkUrl: "https://assets-img.primaverasound.com/1400x1400/2022/ps-single/images/noticias/2022/psb/facebook/brazaletenegro_ed_2400x1256_20220516085356.jpg" },
                { name: "El Larguero", rssUrl: "https://fapi-top.prisasd.com/podcast/playser/el_larguero/itunestfp/podcast.xml", artworkUrl: "https://sdmedia.playser.cadenaser.com/playser/image/20243/21/1711022132571_246.jpeg" },
                { name: "El Morning de Axel y Rulo", rssUrl: "https://www.ivoox.com/feed_fg_f1305937_filtro_1.xml", artworkUrl: "https://static-1.ivoox.com/canales/8/a/b/1/8ab19414779a2ef30569006334fb11b4_XXL.jpg" },
                { name: "El Partidazo de COPE", rssUrl: "https://www.cope.es/api/es/programas/el-partidazo-de-cope/audios/rss.xml", artworkUrl: "https://imagenes.cope.es/uploads/2024/07/03/original_668565c4a89c2.jpeg" },
                { name: "La Libreta de Van Gaal", rssUrl: "https://feeds.megaphone.fm/LALIBRETA2492905101", artworkUrl: "https://megaphone.imgix.net/podcasts/128c35b8-42b3-11ef-9652-43c1220d92c4/image/55fac97bcbc48537a86ffd8390c3772f.jpeg?ixlib=rails-4.3.1&max-w=3000&max-h=3000&fit=crop&auto=format,compress" },
                { name: "La Pizarra de Quintana", rssUrl: "https://www.omnycontent.com/d/playlist/4ac2c3a8-bb0c-499b-bf22-ac8400df1983/23858072-d78f-4b2c-870e-ad95016caf18/272fdbf7-9428-4781-92e9-ad95016eb929/podcast.rss", artworkUrl: "https://www.omnycontent.com/d/playlist/4ac2c3a8-bb0c-499b-bf22-ac8400df1983/23858072-d78f-4b2c-870e-ad95016caf18/272fdbf7-9428-4781-92e9-ad95016eb929/image.jpg?t=1659636005&size=Large" },
                { name: "La Tribu con Raúl Varela", rssUrl: "https://www.omnycontent.com/d/playlist/4ac2c3a8-bb0c-499b-bf22-ac8400df1983/7345e2c8-3edf-4530-b882-ac8700b152e1/a6c99e71-a9ce-48d3-97d9-acaa0101581c/podcast.rss", artworkUrl: "https://www.omnycontent.com/d/playlist/4ac2c3a8-bb0c-499b-bf22-ac8400df1983/7345e2c8-3edf-4530-b882-ac8700b152e1/a6c99e71-a9ce-48d3-97d9-acaa0101581c/image.jpg?t=1610120517&size=Large" },
                { name: "Offsiders", rssUrl: "https://feeds.megaphone.fm/HOT2717170364", artworkUrl: "https://megaphone.imgix.net/podcasts/6782cc76-780b-11ee-9313-9fce8c598dee/image/355dc2fb431dec68d91bae797c9410e1.png?ixlib=rails-4.3.1&max-w=3000&max-h=3000&fit=crop&auto=format,compress" },
                { name: "Tertulia Blanquinegra - Efesista APP", rssUrl: "https://www.ivoox.com/feed_fg_f1156320_filtro_1.xml", artworkUrl: "https://static-2.ivoox.com/canales/7/3/5/9/7051641909537_XXL.jpg" },
                { name: "Tiempo de Juego", rssUrl: "https://www.cope.es/api/es/programas/tiempo-de-juego/audios/rss.xml", artworkUrl: "https://imagenes.cope.es/uploads/2025/01/20/original_678e8defc69bc.jpeg" },
                { name: "¡El Chiringuito de Jugones!", rssUrl: "https://www.ivoox.com/feed_fg_f11226820_filtro_1.xml", artworkUrl: "https://static-2.ivoox.com/canales/1/1/2/7/3351617207211_XXL.jpg" }
            ];
            let episodeCache = new Map();
            
            // --- FUNCIONES ---
            async function fetchAndParseEpisodes(rssUrl) { if (episodeCache.has(rssUrl)) return episodeCache.get(rssUrl); try { const r = await fetch(`${CORS_PROXY}${encodeURIComponent(rssUrl)}`); if (!r.ok) throw new Error(`HTTP error!`); const t = await r.text(), p = new DOMParser(), d = p.parseFromString(t, "application/xml"); if (d.querySelector("parsererror")) throw new Error("Failed to parse RSS feed."); const e = Array.from(d.querySelectorAll("channel > item")).map(i => ({ title: i.querySelector("title")?.textContent || "Sin título", pubDate: new Date(i.querySelector("pubDate")?.textContent || ""), audioUrl: i.querySelector("enclosure")?.getAttribute("url") || "" })).filter(ep => ep.audioUrl).sort((a, b) => b.pubDate - a.pubDate); episodeCache.set(rssUrl, e); return e } catch (error) { console.error(`Error fetching RSS feed ${rssUrl}:`, error); return null } }
            function renderPodcastsView() { showView('podcasts'); podcastsGrid.innerHTML = podcasts.map(p => `<div class="fade-in card-hover" data-rss-url="${p.rssUrl}"><div class="relative"><img src="${p.artworkUrl}" alt="${p.name}" class="w-full h-auto rounded-xl shadow-xl aspect-square object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/300x300/1e293b/f97316?text=Podcast';"><div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-3 rounded-b-xl"><p class="text-center font-semibold text-white truncate">${p.name}</p></div></div></div>`).join(''); podcastsGrid.querySelectorAll('[data-rss-url]').forEach(card => card.addEventListener('click', () => { const p = podcasts.find(pod => pod.rssUrl === card.dataset.rssUrl); if (p) renderEpisodesView(p); })); }
            async function renderEpisodesView(podcast) { showView('episodes'); episodesLoader.classList.remove('hidden'); episodesErrorEl.classList.add('hidden'); episodesList.innerHTML = ''; podcastHeader.innerHTML = `<img src="${podcast.artworkUrl}" alt="${podcast.name}" class="w-40 h-40 mx-auto rounded-xl shadow-2xl mb-4 border-2 border-orange-500/50"><h1 class="text-2xl font-bold">${podcast.name}</h1>`; const episodes = await fetchAndParseEpisodes(podcast.rssUrl); episodesLoader.classList.add('hidden'); if (!episodes) { episodesErrorEl.classList.remove('hidden'); episodesErrorEl.querySelector('button').onclick = () => renderEpisodesView(podcast); return; } episodesCountEl.textContent = episodes.length; episodesList.innerHTML = episodes.length > 0 ? episodes.map((ep, i) => `<div class="episode-card p-4 bg-gray-800/50 rounded-xl cursor-pointer" data-episode-url="${ep.audioUrl}"><div class="flex items-start"><div class="mr-4 text-orange-400 font-bold text-sm">${i + 1}</div><div class="flex-grow"><p class="font-bold text-white">${ep.title}</p><p class="text-xs text-gray-400 mt-1 flex items-center"><i class="far fa-calendar mr-1"></i> ${ep.pubDate.toLocaleDateString()}</p></div><div class="ml-2 text-gray-500 text-lg"><i class="fas fa-play-circle"></i></div></div></div>`).join('') : `<div class="text-center py-10 bg-gray-800/30 rounded-xl"><p class="text-gray-400">No se encontraron episodios.</p></div>`; episodesList.querySelectorAll('[data-episode-url]').forEach(item => item.addEventListener('click', () => { const ep = episodes.find(e => e.audioUrl === item.dataset.episodeUrl); if (ep) playEpisode(ep, podcast); })); }
            function updatePlayerUI(state) { playerEpisodeTitle.textContent = state.episode.title; playerPodcastTitle.textContent = state.podcast.name; playerArtwork.src = state.podcast.artworkUrl; }
            function showView(viewName) { podcastsView.classList.toggle('hidden', viewName !== 'podcasts'); episodesView.classList.toggle('hidden', viewName !== 'episodes'); if (viewName === 'episodes') window.scrollTo(0, 0); }
            function formatTime(seconds) { if (isNaN(seconds) || !isFinite(seconds)) return '0:00'; const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${mins}:${secs < 10 ? '0' : ''}${secs}`; }

            // --- LÓGICA DE REPRODUCCIÓN ---

            function playEpisode(episode, podcast) {
                updatePlayerUI({ episode, podcast });
                player.classList.remove('hidden');

                audioElement.src = CORS_PROXY + encodeURIComponent(episode.audioUrl);
                audioElement.currentTime = 0;
                audioElement.play();

                setupMediaSession({ episode, podcast });
            }

            function setupMediaSession(state) {
                if (!('mediaSession' in navigator)) return;
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: state.episode.title,
                    artist: state.podcast.name,
                    album: state.podcast.name,
                    artwork: [{ src: state.podcast.artworkUrl }]
                });
                navigator.mediaSession.setActionHandler('play', () => audioElement.play());
                navigator.mediaSession.setActionHandler('pause', () => audioElement.pause());
                navigator.mediaSession.setActionHandler('seekbackward', () => updateSeekTime(-15));
                navigator.mediaSession.setActionHandler('seekforward', () => updateSeekTime(30));
                navigator.mediaSession.setActionHandler('seekto', (details) => {
                    if (details.fastSeek && 'fastSeek' in audioElement) {
                        audioElement.fastSeek(details.seekTime);
                    } else {
                        audioElement.currentTime = details.seekTime;
                    }
                    updatePositionState();
                });
            }
            
            function updateSeekTime(time) {
                audioElement.currentTime = Math.max(0, Math.min(audioElement.duration, audioElement.currentTime + time));
                updatePositionState();
            }

            function updatePositionState() {
                if (!('mediaSession' in navigator)) return;
                if (isFinite(audioElement.duration)) {
                    navigator.mediaSession.setPositionState({
                        duration: audioElement.duration,
                        playbackRate: audioElement.playbackRate,
                        position: audioElement.currentTime
                    });
                }
            }

            // --- EVENT LISTENERS ---
            
            backToPodcastsBtn.addEventListener('click', renderPodcastsView);
            playerCloseBtn.addEventListener('click', () => { player.classList.add('hidden'); audioElement.pause(); });
            playerPlayPauseBtn.addEventListener('click', () => { if (audioElement.paused) audioElement.play(); else audioElement.pause(); });
            playerRewindBtn.addEventListener('click', () => updateSeekTime(-15));
            playerForwardBtn.addEventListener('click', () => updateSeekTime(30));
            progressContainer.addEventListener('click', e => { if (!isFinite(audioElement.duration)) return; const r = progressContainer.getBoundingClientRect(); audioElement.currentTime = ((e.clientX - r.left) / r.width) * audioElement.duration; updatePositionState(); });
            
            audioElement.addEventListener('play', () => { playerPlayPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; navigator.mediaSession.playbackState = "playing"; });
            audioElement.addEventListener('pause', () => { playerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; navigator.mediaSession.playbackState = "paused"; });
            audioElement.addEventListener('ended', () => { playerPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; });
            
            audioElement.addEventListener('loadedmetadata', () => {
                durationEl.textContent = formatTime(audioElement.duration);
                updatePositionState();
            });

            audioElement.addEventListener('timeupdate', () => {
                currentTimeEl.textContent = formatTime(audioElement.currentTime);
                if (isFinite(audioElement.duration)) {
                    progressBar.style.width = `${(audioElement.currentTime / audioElement.duration) * 100}%`;
                }
                updatePositionState();
            });

            // --- INICIALIZACIÓN ---
            renderPodcastsView();
            
            // AÑADIDO PARA LA PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(() => console.log('Service Worker registrado con éxito.'))
                    .catch(error => console.log('Error al registrar el Service Worker:', error));
            }

        });
    </script>
</body>
</html>
