<!DOCTYPE html>
<html lang="es" class="bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <stylstylee>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: ffadeInadeIn 0.5s ease-in-out; }
        @keyframes fafadeIn
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        progress[value]::-webkit-progress-bar { background-color: #4a5568; border-radius: 9999px; }
        progress[value]::-webkit-progress-value { background-color: #f6ad55; border-radius: 9999px; transition: width 0.1s linear; }
        .player-shadow { box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3); }
    </style>
</head>
<body class="text-white">

    <!-- Contenedor principal de la aplicación -->
    <div id="app-container" class="pb-40"> <!-- Padding bottom para dejar espacio al reproductor -->

        <!-- Vista: Mis Podcasts -->
        <div id="podcasts-view" class="p-4">
            <h1 class="text-3xl font-bold mb-6 text-orange-400">Mis Podcasts</h1>
            <div id="podcasts-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- Las carátulas de los podcasts se insertarán aquí al instante -->
            </div>
        </div>

        <!-- Vista: Episodios de un Podcast -->
        <div id="episodes-view" class="hidden p-4 fade-in">
            <button id="back-to-podcasts" class="mb-4 text-orange-400 font-semibold">&larr; Volver</button>
            <div id="podcast-header" class="text-center mb-6"></div>
            <h2 class="text-2xl font-bold mb-4">Episodios</h2>
            <div id="episodes-list"></div>
            <div id="episodes-loader" class="text-center py-10">
                <p>Cargando episodios...</p>
            </div>
             <div id="episodes-error" class="hidden text-center py-10 bg-red-900/50 rounded-lg">
                <p>No se pudo cargar el feed RSS de este podcast.</p>
            </div>
        </div>
    </div>

    <!-- Reproductor de Audio Fijo -->
    <div id="player" class="hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-3 player-shadow fade-in">
        <div class="flex items-center mb-2">
            <img id="player-artwork" src="" class="w-14 h-14 rounded-md mr-3" alt="Carátula del episodio">
            <div class="flex-grow overflow-hidden">
                <p id="player-episode-title" class="font-bold text-sm truncate"></p>
                <p id="player-podcast-title" class="text-xs text-gray-400"></p>
            </div>
        </div>
         <div class="w-full mb-2">
            <progress id="player-progress" value="0" max="100" class="w-full h-1.5"></progress>
        </div>
        <div class="flex justify-center items-center space-x-6">
             <button id="player-rewind" class="p-2"></button>
            <button id="player-play-pause" class="p-2 bg-orange-500 rounded-full"></button>
             <button id="player-forward" class="p-2"></button>
        </div>
    </div>

    <!-- Elemento de audio (oculto) -->
    <audio id="audio-element"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DEL DOM ---
            const podcastsView = document.getElementById('podcasts-view');
            const episodesView = document.getElementById('episodes-view');
            const podcastsGrid = document.getElementById('podcasts-grid');
            const episodesList = document.getElementById('episodes-list');
            const podcastHeader = document.getElementById('podcast-header');
            const backToPodcastsBtn = document.getElementById('back-to-podcasts');
            const episodesLoader = document.getElementById('episodes-loader');
            const episodesErrorEl = document.getElementById('episodes-error');
            const player = document.getElementById('player');
            const audioElement = document.getElementById('audio-element');
            const playerArtwork = document.getElementById('player-artwork');
            const playerEpisodeTitle = document.getElementById('player-episode-title');
            const playerPodcastTitle = document.getElementById('player-podcast-title');
            const playerPlayPauseBtn = document.getElementById('player-play-pause');
            const playerRewindBtn = document.getElementById('player-rewind');
            const playerForwardBtn = document.getElementById('player-forward');
            const playerProgress = document.getElementById('player-progress');

            // --- DATOS Y ESTADO ---
            const CORS_PROXY = "https://api.allorigins.win/raw?url=";
            
            // DATOS PRE-CARGADOS PARA CARGA INSTANTÁNEA
            const podcasts = [
                { name: "A dos bandas", rssUrl: "https://www.omnycontent.com/d/playlist/7e594858-42ba-4ecb-86d8-ad1a002e5281/1d39fbf3-b41a-4c54-88ec-adcd0136c774/df3205fa-ee92-4df4-9308-adcd0136c791/podcast.rss", artworkUrl: "https://www.omnycontent.com/d/playlist/7e594858-42ba-4ecb-86d8-ad1a002e5281/1d39fbf3-b41a-4c54-88ec-adcd0136c774/df3205fa-ee92-4df4-9308-adcd0136c791/image.jpg?t=1729520499&size=Large" },
                { name: "Brazalete Negro", rssUrl: "https://www.primaverasound.com/radio/shows/brazalete-negro?action=rss", artworkUrl: "https://assets-img.primaverasound.com/1400x1400/2022/ps-single/images/noticias/2022/psb/facebook/brazaletenegro_ed_2400x1256_20220516085356.jpg" },
                { name: "El Larguero", rssUrl: "https://fapi-top.prisasd.com/podcast/playser/el_larguero/itunestfp/podcast.xml", artworkUrl: "https://sdmedia.playser.cadenaser.com/playser/image/20243/21/1711022132571_246.jpeg" },
                { name: "El Morning de Axel y Rulo", rssUrl: "https://www.ivoox.com/feed_fg_f1305937_filtro_1.xml", artworkUrl: "https://static-1.ivoox.com/canales/8/a/b/1/8ab19414779a2ef30569006334fb11b4_XXL.jpg" },
                { name: "El Partidazo de COPE", rssUrl: "https://www.cope.es/api/es/programas/el-partidazo-de-cope/audios/rss.xml", artworkUrl: "https://imagenes.cope.es/uploads/2024/07/03/original_668565c4a89c2.jpeg" },
                { name: "La Libreta de Van Gaal", rssUrl: "https://feeds.megaphone.fm/LALIBRETA2492905101", artworkUrl: "https://megaphone.imgix.net/podcasts/128c35b8-42b3-11ef-9652-43c1220d92c4/image/55fac97bcbc48537a86ffd8390c3772f.jpeg?ixlib=rails-4.3.1&max-w=3000&max-h=3000&fit=crop&auto=format,compress" },
                { name: "La Pizarra de Quintana", rssUrl: "https://www.omnycontent.com/d/playlist/4ac2c3a8-bb0c-499b-bf22-ac8400df1983/23858072-d78f-4b2c-870e-ad95016caf18/272fdbf7-9428-4781-92e9-ad95016eb929/podcast.rss", artworkUrl: "https://www.omnycontent.com/d/playlist/4ac2c3a8-bb0c-499b-bf22-ac8400df1983/23858072-d78f-4b2c-870e-ad95016caf18/272fdbf7-9428-4781-92e9-ad95016eb929/image.jpg?t=1659636005&size=Large" },
                { name: "La Tribu con Raúl Varela", rssUrl: "https://www.omnycontent.com/d/playlist/4ac2c3a8-bb0c-499b-bf22-ac8400df1983/7345e2c8-3edf-4530-b882-ac8700b152e1/a6c99e71-a9ce-48d3-97d9-acaa0101581c/podcast.rss", artworkUrl: "https://www.omnycontent.com/d/playlist/4ac2c3a8-bb0c-499b-bf22-ac8400df1983/7345e2c8-3edf-4530-b882-ac8700b152e1/a6c99e71-a9ce-48d3-97d9-acaa0101581c/image.jpg?t=1610120517&size=Large" },
                { name: "Offsiders", rssUrl: "https://feeds.megaphone.fm/HOT2717170364", artworkUrl: "https://megaphone.imgix.net/podcasts/6782cc76-780b-11ee-9313-9fce8c598dee/image/355dc2fb431dec68d91bae797c9410e1.png?ixlib=rails-4.3.1&max-w=3000&max-h=3000&fit=crop&auto=format,compress" },
                { name: "Tertulia Blanquinegra - Efesista APP", rssUrl: "https://www.ivoox.com/feed_fg_f1156320_filtro_1.xml", artworkUrl: "https://static-2.ivoox.com/canales/7/3/5/9/7051641909537_XXL.jpg" },
                { name: "Tiempo de Juego", rssUrl: "https://www.cope.es/api/es/programas/tiempo-de-juego/audios/rss.xml", artworkUrl: "https://imagenes.cope.es/uploads/2025/01/20/original_678e8defc69bc.jpeg" },
                { name: "¡El Chiringuito de Jugones!", rssUrl: "https://www.ivoox.com/feed_fg_f11226820_filtro_1.xml", artworkUrl: "https://static-2.ivoox.com/canales/1/1/2/7/3351617207211_XXL.jpg" }
            ];
            
            let sessionCache = new Map();

            // --- ICONOS SVG ---
            const playIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`;
            const pauseIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;
            const rewindIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/></svg>`;
            const forwardIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg>`;
            
            // --- FUNCIONES PRINCIPALES ---

            async function fetchAndParseEpisodes(rssUrl) {
                if (sessionCache.has(rssUrl)) return sessionCache.get(rssUrl);

                try {
                    const response = await fetch(`${CORS_PROXY}${encodeURIComponent(rssUrl)}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const text = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(text, "application/xml");

                    if (xmlDoc.querySelector("parsererror")) { throw new Error("Failed to parse RSS feed."); }

                    const episodes = Array.from(xmlDoc.querySelectorAll("channel > item")).map(item => ({
                        title: item.querySelector("title")?.textContent || "Episodio sin título",
                        pubDate: new Date(item.querySelector("pubDate")?.textContent || ""),
                        description: (item.querySelector("description, content\\:encoded")?.textContent || "Sin descripción.").replace(/<[^>]*>/g, '').substring(0, 120) + '...',
                        audioUrl: item.querySelector("enclosure")?.getAttribute("url") || "",
                    })).filter(ep => ep.audioUrl).sort((a, b) => b.pubDate - a.pubDate);
                        
                    sessionCache.set(rssUrl, episodes);
                    return episodes;

                } catch (error) {
                    console.error(`Error fetching RSS feed ${rssUrl}:`, error);
                    return null;
                }
            }

            function renderPodcastsView() {
                showView('podcasts');
                podcastsGrid.innerHTML = '';

                podcasts.forEach(podcast => {
                    const card = document.createElement('div');
                    card.className = 'fade-in';
                    card.innerHTML = `
                        <img src="${podcast.artworkUrl}" alt="${podcast.name}" class="w-full h-auto rounded-lg shadow-lg aspect-square object-cover cursor-pointer transition-transform duration-300 hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/300x300/1a202c/ff0000?text=Error';">
                        <p class="text-center mt-2 font-semibold text-sm truncate">${podcast.name}</p>
                    `;
                    card.querySelector('img').addEventListener('click', () => renderEpisodesView(podcast));
                    podcastsGrid.appendChild(card);
                });
            }

            async function renderEpisodesView(podcast) {
                showView('episodes');
                episodesLoader.classList.remove('hidden');
                episodesErrorEl.classList.add('hidden');
                podcastHeader.innerHTML = '';
                episodesList.innerHTML = '';

                podcastHeader.innerHTML = `
                    <img src="${podcast.artworkUrl}" alt="${podcast.name}" class="w-32 h-32 mx-auto rounded-lg shadow-xl mb-3">
                    <h1 class="text-2xl font-bold">${podcast.name}</h1>
                `;
                
                const episodes = await fetchAndParseEpisodes(podcast.rssUrl);

                if (!episodes) {
                    episodesLoader.classList.add('hidden');
                    episodesErrorEl.classList.remove('hidden');
                    return;
                }

                if (episodes.length > 0) {
                    episodes.forEach(episode => {
                        const episodeEl = document.createElement('div');
                        episodeEl.className = 'p-3 mb-2 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors duration-200';
                        episodeEl.innerHTML = `
                            <p class="font-bold">${episode.title}</p>
                            <p class="text-xs text-gray-400 mt-1">${episode.pubDate.toLocaleDateString()}</p>
                            <p class="text-sm text-gray-300 mt-2">${episode.description}</p>
                        `;
                        episodeEl.addEventListener('click', () => playEpisode(episode, podcast));
                        episodesList.appendChild(episodeEl);
                    });
                } else {
                     episodesList.innerHTML = `<p class="text-center text-gray-400">No se encontraron episodios.</p>`;
                }
                episodesLoader.classList.add('hidden');
            }

            function playEpisode(episode, podcast) {
                audioElement.src = episode.audioUrl;
                audioElement.play();
                
                const state = { currentTime: 0, episode, podcast };
                updatePlayerUI(state);
                updateMediaSession(state);
            }

            function updatePlayerUI(state) {
                player.classList.remove('hidden');
                playerEpisodeTitle.textContent = state.episode.title;
                playerPodcastTitle.textContent = state.podcast.name;
                playerArtwork.src = state.podcast.artworkUrl;
            }

            function showView(viewName) {
                podcastsView.classList.toggle('hidden', viewName !== 'podcasts');
                episodesView.classList.toggle('hidden', viewName !== 'episodes');
                if (viewName === 'episodes') window.scrollTo(0, 0);
            }

            function updateMediaSession(state) {
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: state.episode.title,
                        artist: state.podcast.name,
                        album: 'Podcasts',
                        artwork: [{ src: state.podcast.artworkUrl, sizes: '512x512' }]
                    });
                    navigator.mediaSession.setActionHandler('play', () => audioElement.play());
                    navigator.mediaSession.setActionHandler('pause', () => audioElement.pause());
                    navigator.mediaSession.setActionHandler('stop', () => {
                        audioElement.pause();
                        audioElement.currentTime = 0;
                        player.classList.add('hidden');
                        localStorage.removeItem('playbackState');
                    });
                    navigator.mediaSession.setActionHandler('seekbackward', () => { audioElement.currentTime = Math.max(0, audioElement.currentTime - 15); });
                    navigator.mediaSession.setActionHandler('seekforward', () => { audioElement.currentTime = Math.min(audioElement.duration, audioElement.currentTime + 30); });
                }
            }
            
            function restorePlaybackState() {
                const savedStateJSON = localStorage.getItem('playbackState');
                if (!savedStateJSON) return;

                const savedState = JSON.parse(savedStateJSON);
                if (!savedState.podcast || !savedState.episode) return;
                
                audioElement.src = savedState.episode.audioUrl;
                audioElement.currentTime = savedState.currentTime;

                updatePlayerUI(savedState);
                updateMediaSession(savedState);
                
                audioElement.addEventListener('loadedmetadata', () => {
                    if (audioElement.duration) {
                        playerProgress.value = (audioElement.currentTime / audioElement.duration) * 100;
                    }
                }, { once: true });
            }

            // --- EVENT LISTENERS ---
            backToPodcastsBtn.addEventListener('click', () => renderPodcastsView());
            playerPlayPauseBtn.addEventListener('click', () => {
                if (audioElement.paused) audioElement.play();
                else audioElement.pause();
            });
            playerRewindBtn.addEventListener('click', () => {
                audioElement.currentTime = Math.max(0, audioElement.currentTime - 15);
            });
            playerForwardBtn.addEventListener('click', () => {
                audioElement.currentTime = Math.min(audioElement.duration || 0, audioElement.currentTime + 30);
            });

            audioElement.addEventListener('play', () => {
                playerPlayPauseBtn.innerHTML = pauseIcon;
                if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
            });
            audioElement.addEventListener('pause', () => {
                playerPlayPauseBtn.innerHTML = playIcon;
                if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused";
            });

            let lastSaveTime = 0;
            audioElement.addEventListener('timeupdate', () => {
                if (audioElement.duration) {
                    playerProgress.value = (audioElement.currentTime / audioElement.duration) * 100;
                    const now = Date.now();
                    if (now - lastSaveTime > 3000) { // Guardar cada 3 segundos
                        const currentStateJSON = localStorage.getItem('playbackState');
                        if (currentStateJSON) {
                            const currentState = JSON.parse(currentStateJSON);
                            currentState.currentTime = audioElement.currentTime;
                            localStorage.setItem('playbackState', JSON.stringify(currentState));
                        }
                        lastSaveTime = now;
                    }
                }
            });
            audioElement.addEventListener('ended', () => {
                player.classList.add('hidden');
                localStorage.removeItem('playbackState');
            });
            audioElement.addEventListener('playing', () => {
                const state = {
                    currentTime: audioElement.currentTime,
                    episode: {
                        title: playerEpisodeTitle.textContent,
                        audioUrl: audioElement.src
                    },
                    podcast: {
                        name: playerPodcastTitle.textContent,
                        artworkUrl: playerArtwork.src
                    }
                };
                localStorage.setItem('playbackState', JSON.stringify(state));
            });

            // --- INICIALIZACIÓN ---
            function init() {
                playerPlayPauseBtn.innerHTML = playIcon;
                playerRewindBtn.innerHTML = rewindIcon;
                playerForwardBtn.innerHTML = forwardIcon;
                renderPodcastsView();
                restorePlaybackState();
            }

            init();
        });
    </script>
</body>
</html>